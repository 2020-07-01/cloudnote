<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset='utf-8'>
    <title>cloudNote</title>
    <link rel='stylesheet' media='screen' href="../static/layui-v2.5.5/layui/css/layui.css" type='text/css'>
    <script src="../static/layui-v2.5.5/layui/layui.js"></script>
    <script src="../static/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="../static/layui_exts/tinymce/js/tinymce/langs/zh_CN.js"></script>
    <script type="text/javascript" src="../static/layui_exts/tinymce/js/tinymce/tinymce.min.js"></script>
    <script type="text/javascript" src="../static/common.js"></script>
    <style>

        .note-title {
            border: none;
        }

        .layui-container {
            width: 100%;
            height: 100%;
            padding: 0 0;
            overflow: hidden;
        }

        .layui-table, .layui-table-view {
            margin: 0 0;
        }

        .layui-form-item {
        }

    </style>
</head>

<body>
<!--顶部导航栏-->
<div class="layui-layout layui-layout-admin">

    <div class="layui-header">
        <div><a class="layui-logo" id="cloudNote" href="/to_index">云笔记平台</a></div>

        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                <span>这是用户名</span>
            </li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll" style="text-align: left;padding-left: 8px">
            <ul class="layui-nav layui-nav-tree" lay-filter="select-type">
                <li class="layui-nav-item">
                    <a><i class="layui-icon layui-icon-edit"></i> 我的笔记</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="#" id="cleanEditSpace"><i class="layui-icon layui-icon-edit"></i> 创建笔记</a></dd>
                        <dd><a href="#" id="all"><i class="layui-icon layui-icon-form"></i> 查看</a></dd>
                        <dd><a href="#" id="starList"><i class="layui-icon layui-icon-star-fill"> 收藏夹</i></a></dd>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-component"></i> 我的资源</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="#" id="toImagePage"><i class="layui-icon layui-icon-picture"></i> 图片</a></dd>
                        <dd><a href="#" id="toFilePage"><i class="layui-icon layui-icon-file-b"></i> 文档</a></dd>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-date"></i> 我的日程</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="#" id="toSchedulePage"><i class="layui-icon layui-icon-form"></i> 查看</a>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-delete"></i> 回收站</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="javascript:;"><i class="layui-icon layui-icon-home"></i> 全部恢复</a></dd>
                        <dd><a href="javascript:;"><i class="layui-icon layui-icon-home"></i> 全部清空</a></dd>
                        <dd><a href="javascript:;"><i class="layui-icon layui-icon-logout"></i> 查看全部</a></dd>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-set"></i> 系统设置</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="#" id="toInformationPage"><i class="layui-icon layui-icon-user"></i> 账号设置</a></dd>
                        <dd><a href="#" id="toResetPasswordPage"><i class="layui-icon layui-icon-password"></i> 修改密码</a>
                        </dd>
                        <dd><a href="#" id="toAdminPage"><i class="layui-icon layui-icon-engine"></i> 后台管理</a></dd>
                        <dd><a href="#" id="logout"><i class="layui-icon layui-icon-prev"></i> 注销登录</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>

    <div class="layui-body">
        <div class="layui-container">
            <div class="layui-row">
                <!--笔记列表-->
                <div class="layui-col-xs3">
                    <div class="grid-demo grid-demo-bg1">
                        <div class="layui-row">
                            <div class="layui-col-xs9">
                                <input id="input-search-note" type="text" placeholder="搜索" autocomplete="off"
                                       class="layui-input"
                                       style="border-right: none;boder-top:none;border-bottom: none;font-size: 16px"/>
                            </div>
                            <div class="layui-col-xs3" style="text-align:center">
                                <button id="search-note" type="button" class="layui-btn layui-btn-primary"
                                        style="border:none;padding: 0 0"><i
                                        class="layui-icon layui-icon-search" style="font-size: 32px;"></i>
                                </button>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-col-xs12" style="text-align:center;">
                                <form class="layui-form" lay-filter="formSelectType" id="2" action="post">
                                    <div class="layui-form-item" style="margin-bottom: 0">
                                        <div class="layui-input-inline" style="width: 100%">
                                            <select name="selectNoteType" id="selectNoteType"
                                                    lay-filter="selectNoteType"
                                                    lay-search>
                                            </select>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="layui-row">
                            <div class="layui-col-xs12">
                                <table class="" lay-skin="ngb" id="note-list"
                                       lay-filter="note-filter"></table>
                            </div>
                        </div>
                    </div>
                </div>
                <!--笔记编辑区-->
                <div class="layui-col-xs9">
                    <div class="grid-demo">
                        <!--标题区-->
                        <div class="layui-row">
                            <div class="layui-col-xs9">
                                <div class="grid-demo">
                                    <div class="layui-input-inline" style="width: 100%;float:left;">
                                        <input type="text" id="note-title" name="noteTitle"
                                               class="layui-input note-title" maxlength="100"
                                               placeholder="标题">
                                    </div>
                                </div>
                            </div>
                            <div class="layui-col-xs3">
                                <div class="grid-demo">
                                    <div class="layui-btn-group" style="float:right">
                                        <button id="saveNote" type="button" class="layui-btn layui-btn-primary"
                                                style="border:none;padding: 0 5px;"><i
                                                class="layui-icon layui-icon-add-1" style="font-size: 32px;"></i>
                                        </button>
                                        <button type="button" id="setType" class="layui-btn layui-btn-primary"
                                                style="border:none;padding: 0 5px"><i
                                                class="layui-icon layui-icon-note" style="font-size: 32px;"></i>
                                        </button>
                                        <button id="delete-note" type="button" class="layui-btn layui-btn-primary"
                                                button-space
                                                style="border:none;padding: 0 5px;" onmouseover="123"><i
                                                class="layui-icon layui-icon-delete" style="font-size: 32px;"></i>
                                        </button>
                                        <button type="button" id="star" class="layui-btn layui-btn-primary"
                                                style="border:none;padding: 0 5px"><i id="ifStar" class="layui-icon"
                                                                                      style="font-size: 32px;">&#xe600;</i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--类型-->
                        <div class="layui-row" id="showType" style="display: none;">
                            <div class="layui-col-xs12" style="margin: 0;">
                                <form class="layui-form" lay-filter="formNoteType" id="1" action="post">
                                    <div class="layui-form-item" style="margin-bottom: 0">
                                        <input type="text" id="inputNoteType" name="inputNoteType"
                                               class="layui-input" autocomplete="off" onkeyup="search()"
                                               placeholder="笔记标签"
                                               style="width: 90%;z-index:2;position:absolute;border-bottom: none;">
                                        <select type="text" name="setNoteType" id="setNoteType" autocomplete="off"
                                                lay-filter="setNoteType" lay-search>
                                        </select>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!--编辑区-->
                        <div class="layui-row">
                            <div class="layui-col-xs12">
                                <div class="layui-row">
                                    <div class="layui-col-xs12" style="width: 100%;height: 100%;">
                                        <textarea name="noteContent" id="noteContent" cols="30" rows="10"
                                                  style="border: none"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-footer layui-bg-black">
            © layui.com - 底部固定区域
        </div>
    </div>
</div>
</body>

<script th:inline="none">

    //设置全局数据
    var token = sessionStorage.getItem("token");
    var globalNoteId = "";
    var flag = true;

    var oldNoteTitle = "";
    var oldNoteContent = "";
    var oldNoteType = "";

    layui.use(['table', 'element', 'form', 'layer'], function () {
        //初始化编辑器
        init_tinymce();

        var table = layui.table;
        var layer = layui.layer;
        var form = layui.form;

        //加载编辑插件
        function init_tinymce() {
            tinymce.init({
                selector: '#noteContent',
                height: 415,
                language: 'zh_CN',
                skin: 'oxide',
                resize: true,
                theme: 'silver',
                menubar: 'file edit format',
                contextmenu: "copy ", //右击菜单
                menu: {
                    edit: {title: '编辑', items: 'undo redo | cut copy  pastetext | selectall'},
                },
                setup: function (editor) {
                    //焦点移入事件
                    editor.on('focus', function () {
                        form.render();
                    });
                    //焦点移出事件
                    editor.on('blur', function () {
                        var noteContent = tinyMCE.activeEditor.getContent();
                        if (globalNoteId == "") {
                            return;
                        }
                        if (noteContent != oldNoteContent) {
                            var data = {
                                "noteContent": noteContent,
                                "noteId": globalNoteId
                            }
                            oldNoteContent = noteContent;
                            update(data, false);
                        }
                    });
                }
            });
        };

        //初始化列表 type, key, star
        init_table("", "", "", true);

        //所有笔记
        $("#all").click(function () {
            init_select();//初始化标签
            clearEidtSpace();
            init_table("", "", "", false);
        });

        //收藏夹
        $("#starList").click(function () {
            init_select();//初始化标签
            clearEidtSpace();
            init_table("", "", "YES", false);
        })

        //根据类型刷新笔记列表
        function init_table(type, key, star, refreshTypeFlag) {
            table.render({
                elem: '#note-list',
                where: {token: token, type: type, key: key, star: star},//传递token到服务端
                type: "get",
                url: 'http://localhost:8080/note/note_list.json', //默认传递两个参数
                headers: {'token': token},
                cellMinWidth: 240, //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                height: 'full-180',
                cols:
                    [[ //标题栏
                        {field: 'showTitle', title: '笔记列表', unresize: true}
                    ]]
                , done:
                    function (res, curr, count) {
                        $('th').css({'text-align': 'center', 'font-size': '17px', 'letter-spacing': '8px'});
                        if (refreshTypeFlag) {
                            init_select();//初始化标签
                        }
                    }
            })
        }

        //点击标题
        table.on('row(note-filter)', function (obj) {
            oldNoteTitle = obj.data.noteTitle;
            $('#note-title').val(obj.data.noteTitle);
            oldNoteContent = obj.data.noteContent;
            tinyMCE.activeEditor.setContent(obj.data.noteContent);
            oldNoteType = obj.data.noteType;
            form.val("formNoteType", {
                "inputNoteType": obj.data.noteType
            });
            showNoteType();//设置标签可见
            globalNoteId = obj.data.noteId;//设置全局笔记id

            //显示是否已经收藏
            var ifStar = obj.data.star;
            if (ifStar == "1") {
                $('#ifStar').html("&#xe658;");
            }
            if (ifStar == "0") {
                $('#ifStar').html("&#xe600;");
            }
        });

        //加星笔记
        $("#star").click(function () {
            var falg = $('#ifStar').val();
            if (flag == "&#xe658;") {
                layer.msg("已收藏");
            }
            ;
            if (globalNoteId == "") {
                layer.msg("请先选择笔记!");
                return;
            }
            ;
            var data = {
                "noteId": globalNoteId
            };
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/note/set_star.json",
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.message);
                        $('#ifStar').html("&#xe658;");//设置为已经收藏
                    } else {
                        layer.msg(result.message);
                    }
                },
            })
        });

        //清除编辑区
        $("#cleanEditSpace").click(function () {
            $('#note-title').val("无标题笔记");//清除标题
            tinyMCE.activeEditor.setContent("");//清除内容
            $('#inputNoteType').val("");//清除标签
            $('#ifStar').html("&#xe600;");//设置空心收藏
            showNoteType();//显示标签
            clearOld();
            globalNoteId = "";
        });

        //清空old值
        function clearOld() {
            oldNoteContent = "";
            oldNoteTitle = "";
            oldNoteType = "";
        }

        //保存
        $("#saveNote").click(function () {
            if (globalNoteId != "") {
                return;
            }
            var noteTitle = $('#note-title').val();
            var noteContent = tinyMCE.activeEditor.getContent();
            var noteType = $('#inputNoteType').val();

            var data = {
                "noteTitle": noteTitle,
                "noteType": noteType,
                "noteContent": noteContent
            }
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/note/save_note.json",
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.message);
                        init_table("", "", "");
                        hideNoteType();
                        clearEidtSpace();
                        init_select();
                    } else {
                        layer.msg(result.message);
                    }
                },
            })
        });


        //删除笔记
        $("#delete-note").click(function () {

            if (globalNoteId == "") {
                layer.msg("请先选择笔记!");
                return;
            }
            var data = {
                "noteId": globalNoteId
            }
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/note/delete_note.json",
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg('删除成功!');
                        init_table("", "", "", false);
                        clearEidtSpace();
                        hideNoteType();
                    }
                },
            })
        });

        //全文搜索
        $("#search-note").click(function () {
            var key = $("#input-search-note").val();
            /* if (key == "") {
                 layer.msg("检索字段不能为空!");
                 return;
             }*/
            //清空的标签值
            form.val("formSelectType", {
                "selectNoteType": ""
            });
            init_table("", key, "", false);
        })


        //设置标签是否可见
        $("#setType").click(function () {
            if (flag == true) {
                $('#showType').css({'display': 'block'});
                flag = false;
                return;
            }
            if (flag == false) {
                $('#showType').css({'display': 'none'});
                flag = true;
                return;
            }
        });

        //隐藏标签
        function hideNoteType() {
            $('#showType').css({'display': 'none'});
            flag = true;
        };

        //显示标签
        function showNoteType() {
            $('#showType').css({'display': 'block'});
            flag = false;
        }

        //清除编辑区
        function clearEidtSpace() {
            $('#note-title').val("");//清除标题
            tinyMCE.activeEditor.setContent("");
            $('#inputNoteType').val("");//清除标签
            $('#ifStar').html("&#xe600;");//设置空心收藏
            globalNoteId = "";
            oldNoteTitle = "";
            oldNoteType = "";
            oldNoteContent = "";
        }

        //初始化标签
        function init_select() {
            $("#selectNoteType").empty();//先对类型进行清空
            $("#setNoteType").empty();//先对类型进行清空
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                url: "http://localhost:8080/note/init_noteType.json",
                success: function (result) {
                    if (result.code == 1) {
                        var selectData = result.data.textValues;
                        $("#selectNoteType").append('<option value="">请选择标签类型</option>');
                        // $("#setNoteType").append('<option value="">请选择标签类型</option>');
                        for (var x in selectData) {
                            $("#selectNoteType").append('<option value = "' + selectData[x].key + '">' + selectData[x].value + '</option>');
                            $("#setNoteType").append('<option value = "' + selectData[x].key + '">' + selectData[x].value + '</option>');
                        }
                        form.render();
                    }
                },
            })
        };

        //右侧标签选择事件
        form.on('select(setNoteType)', function (data) {
            alert("3333");
            //赋值input
            $('#inputNoteType').val(data.value);
            $("#setNoteType").next().find("dl").css({"display": "none"});
            form.render();

            if (globalNoteId == "") {
                return;
            }
            if (data.value != oldNoteTitle) {
                var data1 = {
                    "noteType": data.value,
                    "noteId": globalNoteId
                }
                oldNoteType = data.value;
                update(data1, true);
            }
        });


        window.search = function () {
            var value = $("#inputNoteType").val();
            $("#setNoteType").val(value);
            form.render();
            $("#setNoteType").next().find("dl").css({"display": "block"});
            var dl = $("#setNoteType").next().find("dl").children();
            var j = -1;
            for (var i = 0; i < dl.length; i++) {
                if (dl[i].innerHTML.indexOf(value) <= -1) {
                    dl[i].style.display = "none";
                    j++;
                }
                if (j == dl.length - 1) {
                    $("#setNoteType").next().find("dl").css({"display": "none"});
                }
            }

        }

        //左侧选择事件
        form.on('select(selectNoteType)', function (data) {
            init_table(data.value, "", "");
            hideNoteType();
            clearEidtSpace();
        });

        //类型失去焦点-》判断是否进行更新
        $('#inputNoteType').blur(function () {
            form.render();
            var noteType = $('#inputNoteType').val();
            if (globalNoteId == "") {
                return;
            }
            if (noteType != oldNoteTitle) {
                var data = {
                    "noteType": noteType,
                    "noteId": globalNoteId
                }
                oldNoteType = noteType;
                update(data, true);
            }
        })


        //标题失去焦点时-》判断是否更新
        $('#note-title').blur(function () {
            var noteTitle = $('#note-title').val();
            if (globalNoteId == "") {
                return;
            }
            if (noteTitle != oldNoteTitle) {
                var data = {
                    "noteTitle": noteTitle,
                    "noteId": globalNoteId
                }
                oldNoteTitle = noteTitle;
                update(data, false);
            }
        })


        //更新数据
        function update(data, refreshTypeFlag) {
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/note/save_note.json",
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.message);
                        init_table("", "", "", refreshTypeFlag);
                    } else {
                        layer.msg(result.message);
                    }
                },
            })
        }


        $("#logout").click(function () {
            logout(token);
        })

        $("#toImagePage").click(function () {
            toImagePage(token);
        })

        $("#toFilePage").click(function () {
            toFilePage(token);
        })

        $("#toSchedulePage").click(function () {
            toSchedulePage(token);
        })


        $("#toInformationPage").click(function () {
            toInformationPage(token);
        })

        $("#toAdminPage").click(function () {
            toAdminPage(token);
        })

        $("#toResetPasswordPage").click(function () {
            toResetPasswordPage(token);
        })


    })
</script>
</html>