<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>云笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!--引入layui-->
    <link rel='stylesheet' typeUtils='text/css' media='screen' href='../static/layui-v2.5.5/layui/css/layui.css'>
    <script src="../static/layui-v2.5.5/layui/layui.js"></script>
    <!--引入jquery-->
    <script src="../static/jquery-3.4.1.min.js"></script>
    <style>
        #calendar {
            position: relative;
            width: 94%;
            height: 100%;
        }

        #calendar #layui-laydate1, #calendar #layui-laydate1 .layui-laydate-main, #calendar .layui-laydate-content table {
            width: 100%;
        }

        #calendar .layui-laydate-content td, .layui-laydate-content th {
            height: 55px;
            padding: 1px;
            text-align: center;
        }

        #calendar .layui-laydate-content table tbody {
            height: calc(200vh - 340px);
        }

        .text_box {
            margin: 10px;
        }

        #calendar .layui-laydate-footer {
            position: relative;
            height: 40px;
            line-height: 26px;
            padding: 9px 20px;
        }

        .time-label {
            float: left;
            display: block;
            font-weight: 400;
            text-align: center;
        }

        .layui-unselect dl {
            max-height: 140px;
        }
    </style>
</head>

<body class="layui-layout-body">
<!--顶部导航栏-->
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div><a class="layui-logo" id="cloudNote" href="/to_index">云笔记平台</a></div>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                    admin
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="information">账号设置</a></dd>
                    <dd><a href="">意见反馈</a></dd>
                    <dd><a href="">注销登录</a></dd>
                </dl>
            </li>
        </ul>

    </div>
    <!--左侧导航栏-->
    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll" style="text-align: left;padding-left: 8px">
            <ul class="layui-nav layui-nav-tree" lay-filter="select-type">
                <li class="layui-nav-item">
                    <a><i class="layui-icon layui-icon-edit"></i> 我的笔记</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="/to_note_page"><i class="layui-icon layui-icon-edit"></i> 创建笔记</a>
                        <dd><a href="/to_note_page"><i class="layui-icon layui-icon-form"></i> 查看</a></dd>
                        </dd>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-component"></i> 我的资源</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="/imagePage"><i class="layui-icon layui-icon-picture"></i> 图片</a></dd>
                        <dd><a href="/imagePage"><i class="layui-icon layui-icon-file-b"></i> 文档</a></dd>
                    </dl>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-date"></i> 我的日程</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="/to_schedule_page"><i class="layui-icon layui-icon-form"></i> 查看任务</a></dd>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-delete"></i> 回收站</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="javascript:;"><i class="layui-icon layui-icon-home"></i> 全部恢复</a></dd>
                        <dd><a href="javascript:;"><i class="layui-icon layui-icon-home"></i> 全部清空</a></dd>
                        <dd><a href="javascript:;"><i class="layui-icon layui-icon-home"></i> 查看全部</a></dd>
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="layui-icon layui-icon-set"></i> 系统设置</a>
                    <dl class="layui-nav-child" style="padding-left: 15px">
                        <dd><a href="information"><i class="layui-icon layui-icon-user"></i> 账号设置</a></dd>
                        <dd><a href=""><i class="layui-icon layui-icon-logout"></i> 意见反馈</a></dd>
                        <dd><a href=""><i class="layui-icon layui-icon-logout"></i> 注销登录</a></dd>
                    </dl>
                </li>
            </ul>

        </div>
    </div>

    <div class="layui-body">
        <div class="layui-container" style="padding-top: 3px;">
            <div class="layui-row">
                <div class="layui-col-md12">
                    <div class="layui-inline" id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="layui-footer layui-bg-black">
        © layui.com - 底部固定区域
    </div>
</div>
</body>

<!--任务弹出框-->
<div class="text_box" id="scheduleSpace" style="display: none;">
    <div id="createSpace" style="display: block">
        <div class="layui-row">
            <div class="layui-col-xs12">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-input-inline" style="width: 100%;">
                        <input type="text" id="currentTime" name="noteTitle"
                               class="layui-input note-title"
                               placeholder="活动时间" readonly style="border: none;text-align: center">
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-row">
            <div class="layui-col-xs5">
                <div class="grid-demo grid-demo-bg1">
                    <form class="layui-form" action="post" lay-filter="schedule">
                        <div class="layui-form-item" style="margin-bottom: 0">
                            <div class="layui-input-inline" style="width: 100%">
                                <select name="noteType" id="aheadTime" lay-filter="selectNoteTpe">
                                    <option value="0">不提醒</option>
                                    <option value="5">提前5分钟</option>
                                    <option value="15">提前15分钟</option>
                                    <option value="30">提前30分钟</option>
                                    <option value=60>提前1小时</option>
                                    <option value="120">提前2小时</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="layui-col-xs7">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-input-inline" style="width: 100%;float:left;">
                        <input type="text" id="scheduleTitle" name="noteTitle"
                               class="layui-input note-title"
                               placeholder="标题">
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-row">
            <div class="layui-col-xs12">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-form-item layui-form-text">
                        <textarea id="scheduleContent" class="layui-textarea" placeholder="请输入内容"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="checkSpace" style="display: none">
        <div class="layui-row">
            <div class="layui-col-xs12">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-input-inline" style="width: 100%;">
                        <input type="text" id="123" name="noteTitle"
                               class="layui-input note-title"
                               placeholder="活动时间" readonly style="border: none;text-align: center">
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-row">
            <div class="layui-col-xs5">
                <div class="grid-demo grid-demo-bg1">
                    <form class="layui-form" action="post" lay-filter="schedule">
                        <div class="layui-form-item" style="margin-bottom: 0">
                            <div class="layui-input-inline" style="width: 100%">
                                <select name="noteType" id="f" lay-filter="selectNoteTpe">
                                    <option value="0">不提醒</option>
                                    <option value="0">提前1小时</option>
                                    <option value="0">提前30分钟</option>
                                    <option value="0">提前15分钟</option>
                                    <option value="0">提前10分钟</option>
                                    <option value="0">提前5分钟</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="layui-col-xs7">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-input-inline" style="width: 100%;float:left;">
                        <input type="text" id="f-title" name="noteTitle"
                               class="layui-input note-title"
                               placeholder="标题">
                    </div>
                </div>
            </div>
        </div>

        <div class="layui-row">
            <div class="layui-col-xs12">
                <div class="grid-demo grid-demo-bg1">
                    <div class="layui-form-item layui-form-text">
                        <textarea id=" " class="layui-textarea" placeholder="请输入内容"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    //获取token
    var token = sessionStorage.getItem("token");

    //加载页面日历模块
    layui.use(['layer', 'form', 'laydate', 'element'], function () {
        var layer = layui.layer;
        var laydate = layui.laydate;
        var form = layui.form;

        //mark
        var markData = "";

        //弹窗
        var index;
        //创建全局的switch值,默认为关闭
        var isRemind = "false";
        //加载日历插件
        loading_date();

        //日历插件函数
        function loading_date() {
            markData = JSON.parse(getScheduleList());
            alert(JSON.stringify(markData));
            //加载日历插件
            laydate.render({
                elem: '#calendar'
                , type: 'datetime'
                , theme: 'grid'
                , position: 'static'
                , isInitValue: true //是否允许填充初始值
                , range: false
                , format: 'yyyy-MM-dd HH:mm:ss'
                , value: new Date()
                , calendar: true
                , btns: false
                , change: function (value, date, endDate) {
                    //alert("日期被切换时的回调 ");
                }
                , mark: markData//此处为json对象
                , ready: function (date) {
                    //alert("控件初始打开时的回调");{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}

                }
                , done: function (value, date, endDate) {
                    //选择完毕后的回调
                    //value：得到日期生成的值，也就是点击的日期   2020-03-10 22:09:52
                    //date：得到日期的对象，显示年月日时分秒 例子：{"year":2020,"month":1,"date":8,"hours":22,"minutes":45,"seconds":36}

                    //判读当前选择的时间是否符合要求，如果符合则弹窗否则提示不弹窗
                    isPass(date, value);
                }
                , change: function (value, date, endDate) {
                }
            });
        }

        //判断选择的时间是否符合要求
        function isPass(selectDate, value) {
            var data = {
                "selectDate": value
            }
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/schedule/is_pass.json",
                error: function (result) {
                    alert("123");
                },
                success: function (result) {
                    if (result.code == 1) {
                        createSpace(value, result.message);//弹窗
                    } else {
                        layer.msg(result.message);
                    }
                }
            })
        }

        //弹窗
        function createSpace(value, flag) {
            index = layer.open({
                type: 1,
                skin: 'layui-layer-rim', //加上边框
                title: '添加任务',
                area: ['450px', '350px'], //宽高
                btn: ['创建', '查看', '关闭'],
                content: $("#scheduleSpace")
                , success: function () {
                    if (flag == "true") {
                        $('#currentTime').val(value);

                        $('#createSpace').css({'display': 'block'});
                        $('#checkSpace').css({'display': 'none'});
                    } else {
                        //回显数据
                        $('#createSpace').css({'display': 'none'});
                        $('#checkSpace').css({'display': 'block'});
                    }
                }
                , yes: function () {
                    saveSchedule(value);
                },
                btn2: function () {

                    $('#createSpace').css({'display': 'none'});
                    $('#checkSpace').css({'display': 'block'});
                    alert("查看");
                    return false;
                },
                btn3: function (index, layero) {
                    alert("关闭");
                    //按钮【按钮三】的回调

                    //return false 开启该代码可禁止点击该按钮关闭
                },
                cancel: function () {
                    //右上角关闭回调
                    //return false 开启该代码可禁止点击该按钮关闭
                }
            });
        }

        //活动
        function saveSchedule(value) {
            //获取新的数据
            var scheduleTitle = $('#scheduleTitle').val();
            var scheduleContent = $('#scheduleContent').val();
            var aheadTime = $('#aheadTime').val();
            var data = {
                "aheadTime": aheadTime,
                "scheduleContent": scheduleContent,
                "scheduleTitle": scheduleTitle,
                "executeTime": value
            };
            var jsonData = JSON.stringify(data);//转换为json字符串
            var token = sessionStorage.getItem("token");
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/schedule/save_task",
                error: function (result) {

                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.msg(result.message);
                        //成功之后刷新日历
                        loading_date();
                        layer.close(index);

                    } else {
                        layer.msg(result.message);
                    }
                }
            })

            $('#schedule-content').val("");
            $('#test-n2').html('');//重要！由于插件是嵌套指定容器，再次调用前需要清空原日历控件，清空弹出层
            //markJson[obj_date] = content;
            //再次调用日历控件，重新添数据

            //loding_date(obj_date);//重要！，再标注一个日期后会刷新当前日期变为初始值，所以必须调用当前选定日期。
        }

        //撤销
        function chexiao(obj_date) {
            if (chexiaoExecuteTime == "") {
                layer.msg('请选择日程', {icon: 2});
                return;
            }
            var data = {
                "executeTime": chexiaoExecuteTime
            }
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/schedule/remove_schedule",
                error: function (result) {
                    alert("false");
                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.open({
                            title: '提示',
                            content: result.message,
                            btn: [],
                            time: 1000,
                            shade: 0.5,
                            offset: 'rb',
                            area: ['200px', '120px'],
                            end: function () {
                                //刷新日历
                                loding_date(obj_date);
                            }
                        });
                    } else {
                        layer.open({
                            title: '提示',
                            content: result.message,
                            btn: [],
                            time: 1500,
                            shade: 0.6,
                            offset: 'auto',
                            area: ['200px', '120px']
                        });
                    }
                }
            })
            $('#test-n2').html('');
        }

        //更新
        function updateSchedule(obj_date) {

            if (chexiaoExecuteTime == "") {
                layer.msg('请选择日程', {icon: 2});
                return;
            }

            var hour = $('#check-slide-hour').text();
            var minute = $('#check-slide-minute').text();
            var content = $('#check-schedule-content').val();
            var data = {
                "executeTime": chexiaoExecuteTime, //获取执行时间
                "advanceHour": hour,
                "advanceMinute": minute,
                "scheduleContent": content
            }
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                data: jsonData,
                url: "http://localhost:8080/schedule/update_schedule",
                error: function (result) {
                    alert("false");
                },
                success: function (result) {
                    if (result.code == 1) {
                        layer.open({
                            title: '提示',
                            content: result.message,
                            btn: [],
                            time: 1000,
                            shade: 0.5,
                            offset: 'rb',
                            area: ['200px', '120px'],
                            end: function () {
                                //刷新日历
                                loding_date(obj_date);
                            }
                        });
                    } else {
                        layer.open({
                            title: '提示',
                            content: result.message,
                            btn: [],
                            time: 1500,
                            shade: 0.6,
                            offset: 'auto',
                            area: ['200px', '120px']
                        });
                    }
                }
            })
            $('#test-n2').html('');
        }

        //监听select操作
        form.on('select(execute-time-filter)', function (data) {
            var content_temp = JSON.stringify(data.value);
            var content = content_temp.substring(1, content_temp.length - 1);
            $('#check-schedule-content').val(content);//设置内容
            var executeTime = data.elem[data.elem.selectedIndex].text;
            chexiaoExecuteTime = executeTime;

            var data = {
                "executeTime": executeTime
            }
            var jsonData = JSON.stringify(data);
            //获取提前量
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                data: jsonData,
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                url: "http://localhost:8080/schedule/get_advance_time",
                success: function (result) {
                    //如果提前量为0则进行提示
                    var advanceData = result.data;//获取json数组
                    check_slider_hour.setValue(advanceData.advanceHour);
                    check_slider_minute.setValue(advanceData.advanceMinute);
                    form.render("select");//刷性select，显示出数据
                }, error: function (result) {
                    alert("false");
                }
            });
        });

        //初始化下拉框
        function init_select(showValue) {
            //在初始化之前先清空上一个查询下拉值以及content
            $("#execute-time").empty();
            $('#schedule-content1').val("");
            //封装data数据
            var data = {
                "showExecuteTime": showValue
            }
            var jsonData = JSON.stringify(data);
            $.ajax({
                type: "post",
                contentType: "application/json",
                dataType: 'json',
                //async: false,
                data: jsonData,
                headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
                url: "http://localhost:8080/schedule/get_execute_time",
                success: function (result) {
                    /* check_slider_hour.setValue(0);
                      check_slider_minute.setValue(0);*/
                    //设置初始值，请选择
                    var server = document.getElementById("execute-time"); //server为select定义的id
                    var option = document.createElement("option");  // 创建添加option属性
                    server.appendChild(option);
                    var list = result.data;//获取json数组
                    for (var p in list) {
                        var option = document.createElement("option");  // 创建添加option属性
                        option.setAttribute("value", p); // 给option的value添加值
                        option.innerText = list[p];     // 打印option对应的纯文本
                        server.appendChild(option);           //给select添加option子标签
                    }
                    form.render("select");//刷性select，显示出数据
                }
            });
        }
    });

    //初始化内容
    function init_content() {
        var temp;
        var data = {
            "executeTime": executeTime
        }
        var jsonData = JSON.stringify(data);
        $.ajax({
            type: "post",
            contentType: "application/json",
            dataType: 'json',
            //async: false,
            data: jsonData,
            headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
            url: "http://localhost:8080/schedule/get_execute_content",
            success: function (result) {
                var s = JSON.stringify(result.data);
                temp = s;
            }
        });
        return temp;
    }

    //获取活动内容
    function getScheduleList() {
        var data = "";
        $.ajax({
            type: "get",
            contentType: "application/json",
            dataType: 'json',
            async: false,
            headers: {'Content-Type': 'application/json;charset=utf8', 'token': token},
            url: "http://localhost:8080/schedule/schedule_list.json",
            error: function (result) {

            },
            success: function (result) {
                if (result.code == 1) {
                    data = JSON.stringify(result.data);
                } else {
                    //初始化失败
                }
            }
        });
        return data;
    }
</script>
</html>
